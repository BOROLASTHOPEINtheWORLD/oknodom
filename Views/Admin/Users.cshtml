@model List<OKNODOM.Models.Пользователи>
@{
    Layout = "_AdminLayout";
    ViewData["Title"] = "Пользователи";

    var search = ViewBag.Search as string ?? "";
    var roleFilter = ViewBag.RoleFilter as int? ?? 0;
    var roles = ViewBag.Roles as List<OKNODOM.Models.Роли> ?? new();
}
<div class="filters-section">
    <form method="get" id="filterForm">
        <div class="filter-group">
            <label for="search">Поиск:</label>
            <input type="text"
                   class="search-input"
                   id="search"
                   name="search"
                   value="@search"
                   placeholder="ФИО" />
        </div>
        <div class="filter-group">
            <label for="roleFilter">Роль:</label>
            <select class="filter-select" id="roleFilter" name="roleFilter">
                <option value="0" selected="@(roleFilter == 0)">Все</option>
                @foreach (var role in roles)
                {
                    <option value="@role.КодРоли" selected="@(roleFilter == role.КодРоли)">
                        @role.Название
                    </option>
                }
            </select>
        </div>
        <a asp-action="Users" class="action-btn primary" id="resetBtn">Сбросить</a>
        <a asp-action="CreateUser" asp-controller="Admin" class="action-btn primary" style="align-self: right; margin-left: auto">+ Добавить</a>
    </form>
</div>

@if (Model.Any())
{
    <table class="manager-orders-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>ФИО</th>
                <th>Логин</th>
                <th>Роль</th>
                <th>Телефон</th>
             
                <th>Действия</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var user in Model)
            {
                <tr class="order-row">
                    <td data-label="ID">
                        <strong>#@user.КодПользователя</strong>
                    </td>
                    <td data-label="ФИО">
                        <div class="client-name">
                            @user.Фамилия @user.Имя @user.Отчество
                        </div>
                    </td>
                    <td data-label="Логин">
                        @user.Логин
                    </td>
                    <td data-label="Роль">
                        <span class="status-tag">
                            @user.КодРолиNavigation?.Название
                        </span>
                    </td>
                    <td data-label="Телефон">
                        <a href="tel:@user.Телефон" class="phone-link">
                            @user.Телефон
                        </a>
                    </td>
         
                    <td data-label="Действия">
                        <div class="action-buttons">
                            <a asp-action="EditUser"
                               asp-route-id="@user.КодПользователя"
                               class="action-btn primary">Редактировать</a>

                            @if (user.Активный)
                            {
                                <form asp-action="DeactivateUser" method="post" style="display: inline;">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@user.КодПользователя" />
                                    <button type="submit"
                                            class="action-btn secondary"
                                            onclick="return confirm('Вы уверены, что хотите деактивировать пользователя @user.Фамилия @user.Имя?')">
                                        Деактивировать
                                    </button>
                                </form>
                            }
                            else
                            {
                                <form asp-action="ActivateUser" method="post" style="display: inline;">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@user.КодПользователя" />
                                    <button type="submit"
                                            class="action-btn secondary"
                                            onclick="return confirm('Вы уверены, что хотите активировать пользователя @user.Фамилия @user.Имя?')">
                                        Активировать
                                    </button>
                                </form>
                            }
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}
else
{
    <div class="no-orders-message">
        <h3>Нет пользователей</h3>
        <p>Создайте нового пользователя</p>
    </div>
}

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const filterForm = document.getElementById('filterForm');
            const searchInput = document.getElementById('search');
            const roleFilter = document.getElementById('roleFilter');
            const resetBtn = document.getElementById('resetBtn');

            let debounceTimer;

            function submitFilterForm() {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    filterForm.submit();
                }, 500);
            }

            if (searchInput) {
                let searchTimer;
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchTimer);
                    searchTimer = setTimeout(submitFilterForm, 800);
                });
            }

            if (roleFilter) {
                roleFilter.addEventListener('change', submitFilterForm);
            }

            if (resetBtn) {
                resetBtn.addEventListener('click', function(e) {
                    e.preventDefault();

                    // Очищаем все поля
                    if (searchInput) searchInput.value = '';
                    if (roleFilter) roleFilter.value = '0';

                    // Отправляем форму
                    filterForm.submit();
                });
            }
        });
    </script>
}