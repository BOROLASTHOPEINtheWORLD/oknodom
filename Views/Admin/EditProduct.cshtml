@model OKNODOM.DTOs.ProductEditModel
@{
    Layout = "_AdminLayout";
    ViewData["Title"] = Model.КодТовара.HasValue ? "Редактировать товар" : "Добавить товар";
    var jsonData = new
    {
        Створки = Model.Створки.Select(s => new
        {
            КодСтворки = s.КодСтворки,
            КодТипаСтворки = s.КодТипаСтворки,
            НомерСтворки = s.НомерСтворки
        }).ToList(),
        ТипыСтворок = Model.ТипыСтворок.Select(t => new
        {
            Код = t.Код,
            Название = t.Название
        }).ToList()
    };
}

<div class="header-action-row">
    <h3>@ViewData["Title"]</h3>
    <a asp-action="Products" class="action-btn primary">← Назад к списку</a>
</div>

<div class="order-details-manager-section">
    <form asp-action="SaveProduct" method="post"
          enctype="multipart/form-data"
          class="product-form"
          style="max-width: 1280px; margin: 0 auto;">
        @Html.AntiForgeryToken()
        @if (Model.КодТовара.HasValue)
        {
            <input type="hidden" asp-for="КодТовара" />
        }
        <input type="hidden" asp-for="КодТипаТовара" />

        <!-- Основная информация -->
        <div class="detail-card" style="margin-bottom: 20px;">
            <div class="card-header-main">
                <span>Основная информация</span>
            </div>
            <div class="form-group" style="margin-bottom: 15px;">
                <label class="form-label" asp-for="Название">Название *</label>
                <input asp-for="Название" class="form-input full-width" required
                       placeholder="Введите название товара" />
                <span asp-validation-for="Название" class="text-danger"></span>
            </div>
            <div class="form-row" style="display: flex; gap: 20px; margin-bottom: 15px;">
                <div class="form-group" style="flex: 1;">
                    <label class="form-label" asp-for="Цена">Цена *</label>
                    <div class="input-with-icon" style="position: relative;">
                        <input asp-for="Цена" type="number" step="0.01" class="form-input" required
                               placeholder="0.00" style="width: 100%; padding-right: 40px;" />
                    </div>
                    <span asp-validation-for="Цена" class="text-danger"></span>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label class="form-label" asp-for="Цвет">Цвет</label>
                    <input asp-for="Цвет" class="form-input"
                           placeholder="Например: Белый" style="width: 100%;" />
                </div>
            </div>
            <div class="checkbox-group">
                <label class="checkbox-label">
                    <input asp-for="Активный" type="checkbox" class="checkbox-input" />
                    <span class="checkbox-custom"></span>
                    <span class="checkbox-text">Активный товар</span>
                </label>
            </div>
        </div>

        <!-- Поля для окон -->
        @if (Model.КодТипаТовара == 1)
        {
            <!-- Параметры окна -->
            <div class="detail-card" style="margin-bottom: 20px;">
                <div class="card-header-main">
                    <span>Параметры окна</span>
                </div>

                <div class="form-row" style="display: flex; gap: 20px; margin-bottom: 15px;">
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label" asp-for="КодПрофиля">Профиль *</label>
                        <select asp-for="КодПрофиля" class="form-input" required style="width: 100%;">
                            <option value="">-- Выберите профиль --</option>
                            @foreach (var p in Model.Профили)
                            {
                                <option value="@p.КодПрофиля">@p.Название</option>
                            }
                        </select>
                        <span asp-validation-for="КодПрофиля" class="text-danger"></span>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label" asp-for="КодСтеклопакета">Стеклопакет *</label>
                        <select asp-for="КодСтеклопакета" class="form-input" required style="width: 100%;">
                            <option value="">-- Выберите стеклопакет --</option>
                            @foreach (var g in Model.Стеклопакеты)
                            {
                                <option value="@g.КодСтеклопакета">@g.Название</option>
                            }
                        </select>
                        <span asp-validation-for="КодСтеклопакета" class="text-danger"></span>
                    </div>
                </div>

                <div class="form-row" style="display: flex; gap: 20px; margin-bottom: 15px;">
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label" asp-for="Ширина">Ширина (мм) *</label>
                        <div class="input-with-icon" style="position: relative;">
                            <input asp-for="Ширина" type="number" class="form-input" required
                                   placeholder="Например: 1200" style="width: 100%; padding-right: 50px;" />
                            <span style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--color-text-gray);">мм</span>
                        </div>
                        <span asp-validation-for="Ширина" class="text-danger"></span>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label" asp-for="Высота">Высота (мм) *</label>
                        <div class="input-with-icon" style="position: relative;">
                            <input asp-for="Высота" type="number" class="form-input" required
                                   placeholder="Например: 1500" style="width: 100%; padding-right: 50px;" />
                            <span style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--color-text-gray);">мм</span>
                        </div>
                        <span asp-validation-for="Высота" class="text-danger"></span>
                    </div>
                </div>

                <!-- Гарантия и стандартное -->
                <div class="form-row" style="display: flex; gap: 20px; margin-bottom: 15px;">
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label" asp-for="БазоваяГарантияМесяцев">Базовая гарантия</label>
                        <div class="input-with-icon" style="position: relative;">
                            <input asp-for="БазоваяГарантияМесяцев" type="number" class="form-input"
                                   placeholder="12" style="width: 100%; padding-right: 60px;" />
                            <span style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--color-text-gray);">мес.</span>
                        </div>
                    </div>
                    <div class="form-group" style="flex: 1; margin-top: 28px;">
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input asp-for="Стандартное" type="checkbox" class="checkbox-input" />
                                <span class="checkbox-custom"></span>
                                <span class="checkbox-text">Стандартное окно</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Управление створками -->
            <div class="detail-card" style="margin-bottom: 20px;">
                <div class="card-header-main" style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Створки окна</span>
                    <span class="status-badge" id="sashCounter">@Model.Створки.Count</span>
                </div>

                <div class="form-group" style="margin-bottom: 20px;">
                    <label class="form-label">Количество створок *</label>
                    <div style="display: flex; max-width: 200px;">
                        <button type="button" class="action-btn secondary" id="decreaseSash" style="border-radius: 4px 0 0 4px; padding: 8px 16px;">−</button>
                        <input type="number"
                               id="sashCount"
                               name="КоличествоСтворок"
                               value="@(Model.Створки.Count > 0 ? Model.Створки.Count : 1)"
                               min="1"
                               max="10"
                               class="form-input"
                               style="width: 80px; border-radius: 0; border-left: none; border-right: none; text-align: center; font-weight: bold;"
                               readonly />
                        <button type="button" class="action-btn secondary" id="increaseSash" style="border-radius: 0 4px 4px 0; padding: 8px 16px;">+</button>
                    </div>
                    <div class="text-muted" style="font-size: 12px; margin-top: 5px;">Можно добавить от 1 до 10 створок</div>
                </div>

                <!-- Динамические плашки створок -->
                <div id="sashesContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; margin-top: 20px;">
                    <!-- Сюда динамически добавляются плашки створок -->
                </div>
            </div>
        }

        <!-- Поля для комплектующих -->
        @if (Model.КодТипаТовара == 2)
        {
            <div class="detail-card" style="margin-bottom: 20px;">
                <div class="card-header-main">
                    <span>Параметры комплектующего</span>
                </div>
                <div class="form-row" style="display: flex; gap: 20px; margin-bottom: 15px;">
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label" asp-for="КодТипаКомплектующего">Тип комплектующего *</label>
                        <select asp-for="КодТипаКомплектующего" class="form-input" required style="width: 100%;">
                            <option value="">-- Выберите тип --</option>
                            @foreach (var t in Model.ТипыКомплектующих)
                            {
                                <option value="@t.КодТипа">@t.Название</option>
                            }
                        </select>
                        <span asp-validation-for="КодТипаКомплектующего" class="text-danger"></span>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label" asp-for="КодМатериала">Материал</label>
                        <select asp-for="КодМатериала" class="form-input" style="width: 100%;">
                            <option value="">-- Не выбрано --</option>
                            @foreach (var m in Model.Материалы)
                            {
                                <option value="@m.КодМатериала">@m.Название</option>
                            }
                        </select>
                    </div>
                </div>
                <div class="form-row" style="display: flex; gap: 20px; margin-bottom: 15px;">
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label" asp-for="ДлинаМм">Длина (мм)</label>
                        <div class="input-with-icon" style="position: relative;">
                            <input asp-for="ДлинаМм" type="number" class="form-input" placeholder="0" style="width: 100%; padding-right: 50px;" />
                            <span style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--color-text-gray);">мм</span>
                        </div>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label" asp-for="ШиринаМм">Ширина (мм)</label>
                        <div class="input-with-icon" style="position: relative;">
                            <input asp-for="ШиринаМм" type="number" class="form-input" placeholder="0" style="width: 100%; padding-right: 50px;" />
                            <span style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--color-text-gray);">мм</span>
                        </div>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label" asp-for="ВесКг">Вес (кг)</label>
                        <div class="input-with-icon" style="position: relative;">
                            <input asp-for="ВесКг" type="number" step="0.01" class="form-input" placeholder="0.00" style="width: 100%; padding-right: 50px;" />
                            <span style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--color-text-gray);">кг</span>
                        </div>
                    </div>
                </div>
            </div>
        }
        <!-- Блок для фото товара -->
        <div class="detail-card" style="margin-bottom: 20px;">
            <div class="card-header-main">
                <span>Фотография товара</span>
            </div>

            <!-- Существующее фото -->
            @if (!string.IsNullOrEmpty(Model.Фото))
            {
                <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label">Текущее фото:</label>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <img src="/images/products/@Model.Фото"
                             alt="Фото товара"
                             style="max-width: 200px; max-height: 150px; border: 1px solid #ddd; border-radius: 4px; padding: 3px;" />
                        <div>
                            <div class="text-muted" style="font-size: 14px;">@Model.Фото</div>
                        </div>
                    </div>
                </div>
            }

            <!-- Загрузка нового фото -->
            <div class="form-group">
                <label class="form-label">
                    @if (string.IsNullOrEmpty(Model.Фото))
                    {
                        <span>Загрузить фото товара:</span>
                    }
                    else
                    {
                        <span>Заменить фото:</span>
                    }
                </label>

                <div style="border: 2px dashed #ddd; border-radius: 6px; padding: 20px; text-align: center; background: #fafafa;">
                    <div style="margin-bottom: 15px;">
                        <input type="file"
                               name="фотоФайл"
                               accept="image/*"
                               style="display: none;"
                               id="fileInput"
                               onchange="previewProductImage(this)" />

                        <label for="fileInput" style="cursor: pointer;">
                      
                            <span style="color: var(--color-text-gray); font-size: 14px;">
                                Нажмите для выбора файла 
                            </span>
                        </label>
                    </div>

                    <!-- Превью выбранного фото -->
                    <div id="photoPreview" style="display: none;">
                        <div style="margin-bottom: 10px;">
                            <img id="previewImage"
                                 alt="Предпросмотр"
                                 style="max-width: 200px; max-height: 150px; border: 1px solid #ddd; border-radius: 4px; padding: 3px;" />
                        </div>
                        <div id="fileInfo" style="font-size: 13px; color: var(--color-text-gray);"></div>
                    </div>

                    <!-- Плейсхолдер, если фото не выбрано -->
                    <div id="photoPlaceholder" @if (!string.IsNullOrEmpty(Model.Фото)) {
                    <text>style="display: none;"</text>
                                        }
>
                <div style="color: #999; font-size: 13px;">
                    @if (string.IsNullOrEmpty(Model.Фото))
                    {
                            <span>Фото товара не загружено</span>
                    }
                </div>
            </div>

                    <!-- Существующее фото в режиме превью (при редактировании) -->
                    @if (!string.IsNullOrEmpty(Model.Фото))
                    {
                        <div id="currentPhotoPreview">
                            <div style="margin-bottom: 10px;">
                                <img src="/images/products/@Model.Фото"
                                     alt="Текущее фото"
                                     style="max-width: 200px; max-height: 150px; border: 1px solid #ddd; border-radius: 4px; padding: 3px;" />
                            </div>
                            <div style="font-size: 13px; color: var(--color-text-gray);">Текущее фото: @Model.Фото</div>
                        </div>
                    }

                    <!-- Скрытое поле для имени файла (если не меняем фото) -->
                    <input type="hidden" name="Фото" value="@Model.Фото" id="hiddenPhoto" />
                </div>

            </div>
        </div>

        <!-- Кнопки действий -->
        <div class="form-actions" style="display: flex; gap: 16px; padding-top: 24px; margin-top: 32px; border-top: 1px solid #e1e5eb;">
            <button type="submit" class="action-btn primary" style="padding: 12px 30px;">
                @(Model.КодТовара.HasValue ? "Сохранить изменения" : "Добавить товар")
            </button>
            <a asp-action="Products" class="action-btn secondary" style="padding: 12px 30px;">
                Отмена
            </a>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const container = document.getElementById('sashesContainer');
            const countInput = document.getElementById('sashCount');
            const decreaseBtn = document.getElementById('decreaseSash');
            const increaseBtn = document.getElementById('increaseSash');
            const sashCounter = document.getElementById('sashCounter');

            // Данные из модели
            const modelData = @Html.Raw(Json.Serialize(jsonData));

            // Генерация плашек створок
            function renderSashes() {
                const count = parseInt(countInput.value) || 1;
                container.innerHTML = '';

                // Обновляем счетчик
                sashCounter.textContent = count;
                countInput.value = count;

                for (let i = 1; i <= count; i++) {
                    const sashCard = document.createElement('div');
                    sashCard.style.background = '#f8f9fa';
                    sashCard.style.border = '1px solid #e0e0e0';
                    sashCard.style.borderRadius = '8px';
                    sashCard.style.padding = '20px';
                    sashCard.style.position = 'relative';
                    sashCard.style.transition = 'all 0.3s';

                    // Получаем сохраненные данные для этой створки
                    const savedSash = modelData.створки && modelData.створки.length >= i
                        ? modelData.створки[i - 1]
                        : null;

                    // Заголовок с номером
                    const headerDiv = document.createElement('div');
                    headerDiv.style.marginBottom = '15px';
                    headerDiv.style.paddingBottom = '10px';
                    headerDiv.style.borderBottom = '1px solid #f0f0f0';

                    const numberSpan = document.createElement('span');
                    numberSpan.style.fontWeight = '600';
                    numberSpan.style.color = 'var(--color-primary)';
                    numberSpan.style.fontSize = '16px';
                    numberSpan.textContent = `Створка ${i}`;

                    headerDiv.appendChild(numberSpan);
                    sashCard.appendChild(headerDiv);

                    // Скрытые поля
                    const numberInput = document.createElement('input');
                    numberInput.type = 'hidden';
                    numberInput.name = `Створки[${i - 1}].НомерСтворки`;
                    numberInput.value = i;
                    sashCard.appendChild(numberInput);

                    const idInput = document.createElement('input');
                    idInput.type = 'hidden';
                    idInput.name = `Створки[${i - 1}].КодСтворки`;
                    if (savedSash && savedSash.кодСтворки) {
                        idInput.value = savedSash.кодСтворки;
                    }
                    sashCard.appendChild(idInput);

                    // Выбор типа створки
                    const selectLabel = document.createElement('label');
                    selectLabel.className = 'form-label';
                    selectLabel.textContent = 'Тип створки *';
                    selectLabel.style.marginBottom = '8px';
                    selectLabel.style.display = 'block';

                    const select = document.createElement('select');
                    select.name = `Створки[${i - 1}].КодТипаСтворки`;
                    select.className = 'form-input';
                    select.style.width = '100%';
                    select.required = true;

                    const emptyOption = document.createElement('option');
                    emptyOption.value = '';
                    emptyOption.textContent = '-- Выберите тип --';
                    select.appendChild(emptyOption);

                    // Заполняем опции
                    if (modelData.типыСтворок) {
                        modelData.типыСтворок.forEach(t => {
                            const option = document.createElement('option');
                            option.value = t.код;
                            option.textContent = t.название;

                            // Проверяем выбран ли этот тип
                            if (savedSash && savedSash.кодТипаСтворки == t.код) {
                                option.selected = true;
                            }

                            select.appendChild(option);
                        });
                    }

                    sashCard.appendChild(selectLabel);
                    sashCard.appendChild(select);
                    container.appendChild(sashCard);
                }
            }

            // Обработчики для кнопок степпера
            decreaseBtn.addEventListener('click', function() {
                const current = parseInt(countInput.value) || 1;
                if (current > 1) {
                    countInput.value = current - 1;
                    renderSashes();
                }
            });

            increaseBtn.addEventListener('click', function() {
                const current = parseInt(countInput.value) || 1;
                if (current < 10) {
                    countInput.value = current + 1;
                    renderSashes();
                }
            });

            // Инициализация
            renderSashes();
        });

        // Функция для предпросмотра выбранного фото
        function previewProductImage(input) {
            const previewArea = document.getElementById('photoPreview');
            const placeholder = document.getElementById('photoPlaceholder');
            const currentPhoto = document.getElementById('currentPhotoPreview');
            const previewImage = document.getElementById('previewImage');
            const fileInfo = document.getElementById('fileInfo');
            const hiddenPhoto = document.getElementById('hiddenPhoto');

            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();

                reader.onload = function(e) {
                    // Показываем превью, скрываем плейсхолдер и текущее фото
                    previewArea.style.display = 'block';
                    if (placeholder) placeholder.style.display = 'none';
                    if (currentPhoto) currentPhoto.style.display = 'none';

                    // Устанавливаем изображение
                    previewImage.src = e.target.result;

                    // Очищаем скрытое поле (новый файл будет загружен)
                    hiddenPhoto.value = '';
                }

                reader.readAsDataURL(file);
            } else {
                // Если файл не выбран
                previewArea.style.display = 'none';
                if (currentPhoto) currentPhoto.style.display = 'block';
                if (placeholder) placeholder.style.display = 'block';
            }
        }

        // Drag and drop для фото
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('fileInput');
            const dropArea = fileInput.parentElement.parentElement;

            // Предотвращаем стандартное поведение браузера
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            // Подсвечиваем область при наведении файла
            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });

            function highlight() {
                dropArea.style.borderColor = 'var(--color-primary)';
                dropArea.style.backgroundColor = '#f0f8ff';
            }

            function unhighlight() {
                dropArea.style.borderColor = '#ddd';
                dropArea.style.backgroundColor = '#fafafa';
            }

            // Обработка сброса файла
            dropArea.addEventListener('drop', handleDrop, false);

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;

                if (files.length > 0) {
                    fileInput.files = files;
                    previewProductImage(fileInput);
                }
            }
        });
    </script>
}