@model OKNODOM.DTOs.AdminOrderDetailsViewModel
@{
    var hasConfiguration = Model.ТекущиеТовары.Any() || Model.ТекущиеУслуги.Any();
}

<div class="detail-card config-section mt-4">
    <div class="card-header-main">
        Текущая конфигурация
    </div>

    @if (hasConfiguration)
    {
        // Группируем товары
        var сгруппированныеТовары = Model.ТекущиеТовары
        .GroupBy(t => t.КодТовара)
        .Select(g => new
        {
            Товар = g.First().КодТовараNavigation,
            ОбщееКоличество = g.Sum(x => x.Количество),
            ЦенаНаМоментЗаказа = g.First().ЦенаНаМоментЗаказа,
            ЯвляетсяОкном = g.First().КодТовараNavigation?.Окна != null
        })
        .ToList();

        <div class="config-table-wrapper">
            <table class="config-table">
                <thead>
                    <tr>
                        <th>Наименование</th>
                        <th class="center">Тип</th>
                        <th class="center">Кол-во</th>
                        <th class="center">Цена за ед.</th>
                        <th class="right">Сумма</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var группа in сгруппированныеТовары)
                    {
                        var размеры = группа.ЯвляетсяОкном && группа.Товар.Окна != null
                        ? $"{группа.Товар.Окна.Ширина}×{группа.Товар.Окна.Высота} мм"
                        : группа.Товар.Комплектующие != null
                        ? $"{группа.Товар.Комплектующие.ШиринаМм}×{группа.Товар.Комплектующие.ДлинаМм} мм"
                        : "";
                        var сумма = группа.ЦенаНаМоментЗаказа * группа.ОбщееКоличество;

                        <tr>
                            <td>
                                <div class="product-name">@группа.Товар?.Название</div>
                                @if (!string.IsNullOrEmpty(размеры))
                                {
                                    <div class="product-details">@размеры</div>
                                }
                            </td>
                            <td class="center">
                                @if (группа.ЯвляетсяОкном)
                                {
                                    <span class="type-badge window">Окно</span>
                                }
                                else
                                {
                                    <span class="type-badge accessory">Комплектующее</span>
                                }
                            </td>
                            <td class="center">@группа.ОбщееКоличество шт.</td>
                            <td class="center">@группа.ЦенаНаМоментЗаказа.ToString("N0") Р</td>
                            <td class="right bold">@сумма.ToString("N0") Р</td>
                        </tr>
                    }

                    <!-- Услуги -->
                    @foreach (var услуга in Model.ТекущиеУслуги)
                    {
                        var услугаInfo = услуга.КодУслугиNavigation;
                        var сумма = услуга.ЦенаНаМоментЗаказа * услуга.Количество;

                        <tr>
                            <td>
                                <div class="product-name">@услугаInfo?.Название</div>
                                @if (!string.IsNullOrEmpty(услугаInfo?.Описание))
                                {
                                    <div class="product-details">@услугаInfo.Описание</div>
                                }
                            </td>
                            <td class="center">
                                <span class="type-badge service">Услуга</span>
                            </td>
                            <td class="center">@услуга.Количество шт.</td>
                            <td class="center">@услуга.ЦенаНаМоментЗаказа.ToString("N0") Р</td>
                            <td class="right bold">@сумма.ToString("N0") Р</td>
                        </tr>
                    }
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="4" class="right bold">Товары:</td>
                        <td class="right bold">@Model.СуммаТоваров.ToString("N0") Р</td>
                    </tr>
                    <tr>
                        <td colspan="4" class="right bold">Услуги:</td>
                        <td class="right bold">@Model.СуммаУслуг.ToString("N0") Р</td>
                    </tr>
                    <tr class="total-row">
                        <td colspan="4" class="right">Итого:</td>
                        <td class="right">@Model.ОбщаяСумма.ToString("N0") Р</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    }
    else
    {
        <div class="empty-config-state">
            <div class="empty-config-title">Конфигурация ещё не задана</div>
        </div>
    }
</div>

<div class="mt-4">
    <div class="section-header">
        <h3>Позиции для монтажа</h3>
    </div>

    <div class="positions-list compact">
        @if (Model.Позиции.Any())
        {
            @foreach (var pos in Model.Позиции)
            {
                <div class="position-card">
                    <div class="position-header compact">
                        <div class="position-main-info">
                            <span class="position-name">@pos.Наименование</span>
                            @if (!string.IsNullOrEmpty(pos.Размеры))
                            {
                                <span class="position-size">(@pos.Размеры)</span>
                            }
                        </div>
                        @if (pos.Выполнен)
                        {
                            <div class="status-with-date">
                                <span class="status-badge completed">Завершён</span>
                                @if (pos.ДатаВыполнения.HasValue)
                                {
                                    <span class="completion-date">@pos.ДатаВыполнения.Value.ToString("dd.MM.yyyy HH:mm")</span>
                                }
                            </div>
                        }
                        else
                        {
                            <span class="status-badge pending">Ожидает</span>
                        }
                    </div>

                    <!-- Информация о проёме -->
                    @if (!string.IsNullOrEmpty(pos.ПроёмЭтаж) || !string.IsNullOrEmpty(pos.ПроёмРазмеры))
                    {
                        <div class="proem-info compact">
                            <div class="proem-title">Оконный проём:</div>
                            <div class="proem-details">
                                @if (!string.IsNullOrEmpty(pos.ПроёмЭтаж))
                                {
                                    var floorValue = pos.ПроёмЭтаж.Replace("Этаж:", "").Replace("Этаж", "").Trim();
                                    if (!string.IsNullOrEmpty(floorValue))
                                    {
                                        <span class="proem-detail">
                                            <span class="detail-label">Этаж:</span>
                                            <span class="detail-value">@floorValue</span>
                                        </span>
                                    }
                                }
                                @if (!string.IsNullOrEmpty(pos.ПроёмРазмеры))
                                {
                                    <span class="proem-detail">
                                        <span class="detail-label">Размеры:</span>
                                        <span class="detail-value">@pos.ПроёмРазмеры</span>
                                    </span>
                                }
                                @if (!string.IsNullOrEmpty(pos.ПроёмОписание))
                                {
                                    <div class="proem-description">
                                        <span class="detail-label">Описание:</span>
                                        <span class="detail-value">@pos.ПроёмОписание</span>
                                    </div>
                                }
                            </div>
                        </div>
                    }

                    <!-- Фото монтажа (только просмотр) -->
                    @if (pos.Выполнен && !string.IsNullOrEmpty(pos.Фотография))
                    {
                        <div class="completed-section">
                            <div class="success-message">
                                <div class="message-text">Монтаж завершён</div>
                                <div class="photo-preview existing">
                                    <div class="photo-title">Фото монтажа:</div>
                                    <div class="photo-wrapper">
                                        <img src="/images/uploads/@pos.Фотография" alt="Фото монтажа" class="existing-photo" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                    else if (!pos.Выполнен)
                    {
                        <div class="pending-section">
                            <div class="message-text">Ожидает монтажа</div>
                        </div>
                    }
                </div>
            }
        }
        else
        {
            <div class="empty-state">
                <div class="empty-text">Нет позиций для монтажа</div>
            </div>
        }
    </div>
</div>